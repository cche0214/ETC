MySQL + MyCat 分库分表架构设计详尽说明（实验总结文档）
====================================================

一、实验背景与需求分析
----------------------

本项目处理来自多个 CSV 文件的交通过车全量数据（非流式）。数据按日期分文件，但字段完全一致，主要字段包括：

GCXH（过车序号，唯一）、XZQHMC（行政区划）、ROAD_ID、K_INDEX、BOUNDARY_* 系列、FXLX、GCSJ（过车时间）、GCSJ_TS（时间戳）、HPHM（车牌号）、BRAND（品牌）。

查询需求包括：

1. 按车牌 HPHM 查询轨迹
2. 按时间范围查询过车记录
3. 按行政区划统计
4. 按卡口统计
5. 提供给 LangChain SQLAgent 进行自动 SQL 查询

因此数据库必须支持高并发、高效过滤、可扩展的能力。

二、为什么使用 MyCat？
----------------------

MyCat 支持分库（Sharding）、分表（Partitioning）、统一逻辑库、SQL 路由与结果合并。

其本质：

把多个 MySQL 库伪装为一个逻辑库，由 MyCat 决定 SQL 去哪个库、哪个表。

三、数据特性分析（决定分库方案的关键）
--------------------------------------

1. 行政区划数据分布不均衡（睢宁 ≈27%，新沂 ≈19%，铜山≈18% 等）。
2. 多数查询按车牌号 HPHM 进行轨迹查询。
3. 时间戳 GCSJ_TS 可用于高效范围查询。
4. 行政区之间数据相对独立，非常适合按 XZQHMC 做“分库”。

四、最终分库分表设计方案
------------------------

A. 分库 —— 按行政区划 XZQHMC 分库
-----------------------------------

三台 MySQL 映射如下：

node1（192.168.88.131） → traffic_db1  
存：睢宁县、丰县、高速五大队

node2（192.168.88.132） → traffic_db2  
存：新沂市、邳州市

node3（192.168.88.133） → traffic_db3  
存：铜山县、沛县

好处：
- 查询行政区数据几乎总命中唯一库
- 三台机器负载更均衡
- 数据天然分组

B. 分表 —— 按车牌号 HPHM HASH 分为 4 张表
-------------------------------------------

每个物理库包含：

etc_records_0  
etc_records_1  
etc_records_2  
etc_records_3  

分表规则：

hash(HPHM) % 4

特点：
- 每次轨迹查询命中单表
- 车牌脱敏不影响哈希
- 减小单表大小，提高性能

C. 最终物理结构（MySQL 层）
----------------------------

共有 12 张真实表：3 库 × 每库 4 表。

每库结构相同：
etc_records_0
etc_records_1
etc_records_2
etc_records_3

D. 逻辑结构（MyCat 层）
-----------------------

对应用只有 1 张逻辑表：

TRAFFIC.etc_records

MyCat 负责路由：

第一层：按行政区划选择库  
第二层：按车牌号选择子表

用户查询完全无感知。

五、MyCat 路由工作流程
------------------------

示例 SQL：

SELECT * FROM etc_records WHERE HPHM='苏A12345' AND XZQHMC='睢宁县';

MyCat 执行流程：

1. 根据 XZQHMC 选择库 → traffic_db1（node1）
2. 根据 HPHM 哈希选择分表 → etc_records_2
3. 在 node1 的 etc_records_2 执行 SQL
4. 返回结果（逻辑上只有一张表）

六、为什么暂不实现主从？
-------------------------

主从复制要求：

主库与从库数据必须完全一致。

但本项目为分库架构：

traffic_db1、traffic_db2、traffic_db3 的数据本来就不同。

因此这些库不能互为主从，否则会破坏分库结构。

正确做法：

每个分库需要独立的 slave（例如 traffic_db1_slave）。

由于目前三台机器均作为主库，尚未配置从库，因此暂不实现主从分离。

七、必须建立的索引（性能关键）
------------------------------

在每个分表上建立：

CREATE INDEX idx_hphm ON etc_records_0(HPHM);
CREATE INDEX idx_time ON etc_records_0(GCSJ_TS);
CREATE INDEX idx_area ON etc_records_0(XZQHMC);

作用：
- HPHM：轨迹查询极快
- GCSJ_TS：时间范围查询快
- XZQHMC：优化 MyCat 路由与过滤

每个表（0～3）都建立相同索引。

八、实验关键结论总结
---------------------

1. 本项目使用“三库 × 四表”结构，共 12 张物理表。
2. 行政区划用于分库，车牌号用于分表。
3. MyCat 将 12 张表统一为逻辑表 TRAFFIC.etc_records。
4. SQL 路由由 MyCat 自动完成（行政区划 → 分库；车牌号 → 分表）。
5. 索引对查询性能至关重要。
6. 主从需要额外从库，本阶段不实现。

九、后续扩展方向
----------------

1. 每个分库增加从库，实现读写分离。
2. 按月份做冷热分离归档。
3. 为 SQLAgent 构建查询模板与限制。
4. 加 Redis 做热门数据缓存。

文档结束
