# 🚦 高速公路 ETC 大数据管理与监控系统（项目功能说明）

## 1. 项目概述

本项目为**高速公路 ETC 大数据管理与监控系统**，围绕多源、跨月、质量不一致的过车数据，构建了一套完整的数据**采集、清洗、存储、计算与智能分析体系**。

系统以 ETC 过车数据为核心，结合 **HBase、Redis、MySQL、Flink 与 LSTM 模型**，实现对高速公路交通运行状态的**实时监控、业务统计、智能查询与预测分析**。

系统主要服务对象包括：

- **实时监控**：展示当前卡口车流状态及短时趋势预测  
- **业务统计**：对过车数据进行多维统计分析与可视化  
- **智能查询**：支持复杂条件组合的历史过车数据查询与导出  
- **预测分析**：基于历史流量数据进行短期交通流预测  

---

## 2. 系统总体架构

系统采用**前后端分离 + 分层架构设计**，后端主要分为四个层次：

1. **接口层（Routes / Blueprints）**  
   - 接收客户端请求  
   - 解析请求参数  
   - 统一封装并返回响应结果  

2. **业务逻辑层（Services / Dashboard Modules）**  
   - 负责业务规则处理  
   - 实现统计分析、查询逻辑与预测调用  

3. **数据访问层（DB / Session）**  
   - 负责与 HBase、Redis、MySQL 的交互  
   - 统一管理数据库连接与会话  

4. **算法模型层（Prediction）**  
   - 负责 LSTM 模型加载  
   - 执行交通流预测计算  

---

## 3. 业务统计模块（Dashboard）

业务统计模块用于**宏观与中观层面的交通运行分析**，主要由以下文件实现：

### 3.1 数据总览（overview.py）

**功能说明：**

- 统计 ETC 过车数据的总体规模  
- 区分进城（入徐）与出城（出徐）车流量  
- 为系统首页提供核心指标数据  

**数据来源：**

- HBase：`etc_traffic_data` 表  
- 使用字段 `info:FXLX` 表示行驶方向  

---

### 3.2 统计分析（analysis.py）

**功能说明：**

- 车辆品牌 Top10 统计分析  
- 车辆类型分布统计（小型车、大型车、挂车等）  

**实现特点：**

- 基于 HBase Scan 操作进行样本或全量统计  
- 返回前端 ECharts 可直接使用的数据结构  

---

### 3.3 套牌车报警（alerts.py）

**功能说明：**

- 展示疑似套牌车辆报警信息  
- 报警结果由 Flink 实时计算后写入 Redis  

**数据来源：**

- Redis List：`Traffic:Alert:Decked`  
- 默认返回最近 50 条报警记录  

---

### 3.4 实时可视化（realtime.py）

**功能说明：**

- 江苏省车辆来源城市分布（地图可视化）  
- 各重点卡口实时车流展示  

**数据来源：**

- HBase：最新过车数据（城市分布统计）  
- Redis：实时卡口流量数据  

---

## 4. 实时监控与预测模块（Prediction）

实时监控模块用于**短时交通流预测与趋势展示**，由以下文件协同实现：

### 4.1 预测模型服务（predictor.py）

**功能说明：**

- 加载各卡口对应的 LSTM 预测模型  
- 对最近 11 个 5 分钟时间点的流量数据进行建模  
- 预测下一个 5 分钟时间窗口内的车流量  

**技术特点：**

- 多卡口独立模型设计  
- 使用模型缓存机制，避免重复加载  
- 模型作为内部服务，不直接对外暴露接口  

---

### 4.2 实时预测接口（prediction/routes.py）

**功能说明：**

- 从 Redis 获取最新车流时间序列  
- 调用 `predictor.py` 完成预测计算  
- 将历史流量与预测结果一并返回前端  

**数据来源：**

- Redis Hash：`Traffic:Flow:{卡口名称}`  
- Redis Key：`Traffic:LatestTime`  

---

## 5. 智能查询模块（Search）

智能查询模块用于**历史过车数据的多条件组合查询与导出**。

### 5.1 查询接口层（search/routes.py）

**功能说明：**

- 接收前端 POST JSON 查询条件  
- 支持分页查询  
- 支持查询结果导出（CSV）  

**职责定位：**

- 负责 HTTP 请求与响应  
- 不直接拼接 SQL  
- 不直接操作数据库  

---

### 5.2 查询服务层（search/services.py）

**功能说明：**

- 将前端 JSON 查询条件解析为 SQL WHERE 子句  
- 支持精确、模糊、前缀匹配  
- 支持多选条件、时间区间、分页与排序  

**技术实现：**

- 使用参数化 SQL 防止 SQL 注入  
- 通过 SQLAlchemy Session 执行查询  
- 返回 Python 数据结构供接口层使用  

---

## 6. 数据访问与连接管理（db.py）

系统统一在 `db.py` 中管理数据源连接：

- **HBase**：存储海量 ETC 过车明细数据  
- **Redis**：存储实时流量、报警信息与时间戳  
- **MySQL（ShardingSphere-Proxy）**：存储结构化查询数据  

### 核心机制说明：

- 使用 `create_engine` 创建数据库引擎并管理连接池  
- 使用 `sessionmaker` 创建 Session 工厂  
- 使用 `Session.execute()` 执行 SQL 语句  
- 查询结果统一转换为 Python 字典结构  

---

## 7. 一次完整查询的执行流程（示例）

```text
客户端发起查询请求
        ↓
search/routes.py 接收 POST JSON
        ↓
search/services.py 构建 SQL 查询条件
        ↓
SQLAlchemy Session.execute()
        ↓
MySQL 执行 SQL 查询
        ↓
返回结果集 result_proxy
        ↓
转换为 Python list[dict]
        ↓
routes.py 封装为 JSON 响应
        ↓
返回前端
